<!doctype html><html>
<head>
<meta charset=utf-8>
<meta name=pinterest content="nopin">
<meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1">
<link rel=canonical href=https://scotttactical.com/django-search-multiple-fields/>
<link href=//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css rel=stylesheet>
<link rel=stylesheet href=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css>
<title>Django Search: Multiple Fields and Full Text - Scott Tactical</title>
<meta name=description content="Text Search - Django Model Fields Django has a pretty flexible ORM, but sometimes clients need a free-form text search to get down to the content that you are looking for. It is beyond the capability of most engineers to build a comprehensive search tool and shoehorn it into an existing application. There are people working on these problems for years.This does remind me of a senior boss that asked me to add a fuzzy search field to an application and that it was &amp;ldquo;super simple&amp;rdquo;.">
<meta property="og:title" content="Django Search: Multiple Fields and Full Text - Scott Tactical">
<meta property="og:type" content="article">
<meta property="og:url" content="https://scotttactical.com/django-search-multiple-fields/">
<meta property="og:image" content="https://scotttactical.com/images/default.png">
<meta property="og:site_name" content="Scott Tactical">
<meta property="og:description" content="Text Search - Django Model Fields Django has a pretty flexible ORM, but sometimes clients need a free-form text search to get down to the content that you are looking for. It is beyond the capability of most engineers to build a comprehensive search tool and shoehorn it into an existing application. There are people working on these problems for years.This does remind me of a senior boss that asked me to add a fuzzy search field to an application and that it was &amp;ldquo;super simple&amp;rdquo;.">
<meta property="og:locale" content="ja_JP">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:site content="Scott Tactical">
<meta name=twitter:url content="https://scotttactical.com/django-search-multiple-fields/">
<meta name=twitter:title content="Django Search: Multiple Fields and Full Text - Scott Tactical">
<meta name=twitter:description content="Text Search - Django Model Fields Django has a pretty flexible ORM, but sometimes clients need a free-form text search to get down to the content that you are looking for. It is beyond the capability of most engineers to build a comprehensive search tool and shoehorn it into an existing application. There are people working on these problems for years.This does remind me of a senior boss that asked me to add a fuzzy search field to an application and that it was &amp;ldquo;super simple&amp;rdquo;.">
<meta name=twitter:image content="https://scotttactical.com/images/default.png">
<script type=application/ld+json>{"@context":"http://schema.org","@type":"NewsArticle","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/scotttactical.com\/"},"headline":"Django Search: Multiple Fields and Full Text - Scott Tactical","image":{"@type":"ImageObject","url":"https:\/\/scotttactical.com\/images\/default.png","height":800,"width":800},"datePublished":"2016-03-22T22:34:50JST","dateModified":"2016-03-22T22:34:50JST","author":{"@type":"Person","name":"Scott Tactical"},"publisher":{"@type":"Organization","name":"Scott Tactical","logo":{"@type":"ImageObject","url":"https:\/\/scotttactical.com\/images/logo.png","width":600,"height":60}},"description":"Text Search - Django Model Fields Django has a pretty flexible ORM, but sometimes clients need a free-form text search to get down to the content that you are looking for. It is beyond the capability of most engineers to build a comprehensive search tool and shoehorn it into an existing application. There are people working on these problems for years.\nThis does remind me of a senior boss that asked me to add a fuzzy search field to an application and that it was \u0026ldquo;super simple\u0026rdquo;."}</script>
<link href=https://scotttactical.com/css/styles.css rel=stylesheet>
</head>
<body>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-53440065-2','auto'),ga('send','pageview'))</script>
<header class=l-header>
<nav class="navbar navbar-default">
<div class=container>
<div class=navbar-header>
<button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#navbar aria-expanded=false>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://scotttactical.com/>Scott Tactical</a>
</div>
<div id=navbar class="collapse navbar-collapse">
<ul class="nav navbar-nav navbar-right">
<li><a href=/about/>About</a></li>
</ul>
</div>
</div>
</nav>
</header>
<main>
<div class=container>
<div class=row>
<div class=col-md-8>
<nav class=p-crumb>
<ol class=breadcrumb>
<li><a href=https://scotttactical.com/><i class="fa fa-home" aria-hidden=true></i></a></li>
<li itemscope itemtype=http://data-vocabulary.org/Breadcrumb><a href=https://scotttactical.com/post/ itemprop=url><span itemprop=title>post</span></a></li>
<li class=active>Django Search: Multiple Fields and Full Text</li>
</ol>
</nav>
<article class=single>
<header>
<ul class=p-facts>
<li><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2016-03-22T22:34:50JST>Mar 22, 2016</time></li>
<li><i class="fa fa-bookmark" aria-hidden=true></i><a href=https://scotttactical.com/post/>post</a></li>
</ul>
<h1 class=title>Django Search: Multiple Fields and Full Text</h1>
</header>
<div class=article-body><h2 id=text-search---django-model-fields>Text Search - Django Model Fields</h2>
<p>Django has a pretty flexible ORM, but sometimes clients need a free-form text search to get down to the content that you are looking for. It is beyond the capability of most engineers to build a comprehensive search tool and shoehorn it into an existing application. There are people working on these problems for years.</p>
<p>This does remind me of a senior boss that asked me to add a fuzzy search field to an application and that it was &ldquo;super simple&rdquo;. He said &ldquo;you just do a LIKE statement against all the fields we care about!&rdquo; and proceeded to pseudo code it for me. He should read my post about how not to F&rsquo;k up your engineering staff.</p>
<h3 id=searching-with-like-statements>Searching with Like Statements</h3>
<p>This is probably the first place an inexperienced engineer will start. Just pick the field and do a LIKE statement against it.</p>
<p>ex:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>User<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter(username__icontains<span style=color:#f92672>=</span>keyword)
</code></pre></div><p>Which will result in:
<code>SELECT * FROM ... WHERE USERNAME LIKE </code></p>
<p>This doesn&rsquo;t scale. It&rsquo;s amateurish.</p>
<p>But this will satisfy an annoying manager for the time being considering they probably know little about computer science.</p>
<h3 id=using-q-objects>Using Q Objects</h3>
<p>The <a href=https://docs.djangoproject.com/en/dev/topics/db/queries/#complex-lookups-with-q-objects>Q object</a> in Django is kinda nice. It wraps the queryset. I need a little more information on it to be able to speak intelligently. But that aside I decided to use it in a few places where dynamic queries were valuable.</p>
<p>After doing a little looking I found this response on <a href=http://stackoverflow.com/questions/26634874/how-can-i-make-django-search-in-multiple-fields-using-querysets-and-mysql-full>stack overflow</a> where they suggested using this. I can tell immediately that it&rsquo;s not very scalable under big load. At the least I can get it going now with only minor levels of sin.</p>
<p>That post is apparently taken from <a href=http://julienphalip.com/post/2825034077/adding-search-to-a-django-site-in-a-snap>Julien Phalip - adding search to django in a snap.</a>. So credit is given. Nice work.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>normalize_query</span>(query_string,
    findterms<span style=color:#f92672>=</span>re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;&#34;([^&#34;]+)&#34;|(\S+)&#39;</span>)<span style=color:#f92672>.</span>findall,
    normspace<span style=color:#f92672>=</span>re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;\s{2,}&#39;</span>)<span style=color:#f92672>.</span>sub):

    <span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>    Splits the query string in invidual keywords, getting rid of unecessary spaces and grouping quoted words together.
</span><span style=color:#e6db74>    Example:
</span><span style=color:#e6db74>    &gt;&gt;&gt; normalize_query(&#39;  some random  words &#34;with   quotes  &#34; and   spaces&#39;)
</span><span style=color:#e6db74>        [&#39;some&#39;, &#39;random&#39;, &#39;words&#39;, &#39;with quotes&#39;, &#39;and&#39;, &#39;spaces&#39;]
</span><span style=color:#e6db74>    &#39;&#39;&#39;</span>

    <span style=color:#66d9ef>return</span> [normspace(<span style=color:#e6db74>&#39;&#39;</span>,(t[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>or</span> t[<span style=color:#ae81ff>1</span>])<span style=color:#f92672>.</span>strip()) <span style=color:#66d9ef>for</span> t <span style=color:#f92672>in</span> findterms(query_string)]

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_query</span>(query_string, search_fields):

    <span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>    Returns a query, that is a combination of Q objects.
</span><span style=color:#e6db74>    That combination aims to search keywords within a model by testing the given search fields.
</span><span style=color:#e6db74>    &#39;&#39;&#39;</span>

    query <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span> <span style=color:#75715e>## Query to search for every search term</span>
    terms <span style=color:#f92672>=</span> normalize_query(query_string)
    <span style=color:#66d9ef>for</span> term <span style=color:#f92672>in</span> terms:
        or_query <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span> <span style=color:#75715e>## Query to search for a given term in each field</span>
        <span style=color:#66d9ef>for</span> field_name <span style=color:#f92672>in</span> search_fields:
            q <span style=color:#f92672>=</span> Q(<span style=color:#f92672>**</span>{<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>__icontains&#34;</span> <span style=color:#f92672>%</span> field_name: term})
            <span style=color:#66d9ef>if</span> or_query <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
                or_query <span style=color:#f92672>=</span> q
            <span style=color:#66d9ef>else</span>:
                or_query <span style=color:#f92672>=</span> or_query <span style=color:#f92672>|</span> q
        <span style=color:#66d9ef>if</span> query <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
            query <span style=color:#f92672>=</span> or_query
        <span style=color:#66d9ef>else</span>:
            query <span style=color:#f92672>=</span> query <span style=color:#f92672>&amp;</span> or_query

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>search_for_something</span>(request):
   query_string <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
   found_entries <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
   <span style=color:#66d9ef>if</span> (<span style=color:#e6db74>&#39;q&#39;</span> <span style=color:#f92672>in</span> request<span style=color:#f92672>.</span>GET) <span style=color:#f92672>and</span> request<span style=color:#f92672>.</span>GET[<span style=color:#e6db74>&#39;q&#39;</span>]<span style=color:#f92672>.</span>strip():
       query_string <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>GET[<span style=color:#e6db74>&#39;q&#39;</span>]
       entry_query <span style=color:#f92672>=</span> get_query(query_string, [<span style=color:#e6db74>&#39;field1&#39;</span>, <span style=color:#e6db74>&#39;field2&#39;</span>, <span style=color:#e6db74>&#39;field3&#39;</span>])
       found_entries <span style=color:#f92672>=</span> Model<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter(entry_query)<span style=color:#f92672>.</span>order_by(<span style=color:#e6db74>&#39;-something&#39;</span>)

   <span style=color:#66d9ef>return</span> render_to_response(<span style=color:#e6db74>&#39;app/template-result.html&#39;</span>,
           { <span style=color:#e6db74>&#39;query_string&#39;</span>: query_string, <span style=color:#e6db74>&#39;found_entries&#39;</span>: found_entries },
           context_instance<span style=color:#f92672>=</span>RequestContext(request)
       )
</code></pre></div><p>Another helpful resource was from <a href=https://yeti.co/blog/global-search-in-django-rest-framework/>Yeti</a> adding in some global search. A bit outdated but a nice resource.</p>
<h3 id=search-library>Search Library</h3>
<p><a href=https://github.com/django-haystack/django-haystack>https://github.com/django-haystack/django-haystack</a></p>
<p><a href=https://github.com/etianen/django-watson>https://github.com/etianen/django-watson</a></p>
</div>
<footer class=article-footer>
<section class=bordered>
<header>
<div class=panel-title>TAGS</div>
</header>
<div>
<ul class=p-terms>
<li><a href=https://scotttactical.com/tags/software/>software</a></li>
<li><a href=https://scotttactical.com/tags/django/>django</a></li>
<li><a href=https://scotttactical.com/tags/data/>data</a></li>
</ul>
</div>
</section>
</footer>
</article>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//scotttactical.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<div class=col-md-4>
<aside class=l-sidebar>
<section class="panel panel-default">
<div class=panel-heading>
<div class=panel-title>LATESTS</div>
</div>
<div class=list-group>
<a href=https://scotttactical.com/why-i-converted-to-catholicism/ class=list-group-item>Why I Converted To Catholicism</a>
<a href=https://scotttactical.com/ejs-2019-departure-preparations/ class=list-group-item>Easter Jeep Safari 2019 - Departure Preparations</a>
<a href=https://scotttactical.com/ejs-2019-transit/ class=list-group-item>EJS 2019 - The Slow Route There </a>
<a href=https://scotttactical.com/car-computer-face-recognition/ class=list-group-item>Car Computer Face Recognition</a>
<a href=https://scotttactical.com/biometric-vehicle-entry-car-computer/ class=list-group-item>Biometric Vehicle Entry</a>
<a href=https://scotttactical.com/installing-usb-relay/ class=list-group-item>Installing a USB Relay</a>
<a href=https://scotttactical.com/car-computer-touchscreen-monitor/ class=list-group-item>Car Computer Touchscreen Monitor</a>
<a href=https://scotttactical.com/linux-usb-relay-controller/ class=list-group-item>Linux USB Relay Controller</a>
<a href=https://scotttactical.com/car-computer-camera/ class=list-group-item>Car Computer Camera</a>
<a href=https://scotttactical.com/car-computer-hardware/ class=list-group-item>Car Computer Hardware</a>
</div>
</section>
<section class="panel panel-default">
<div class=panel-heading>
<div class=panel-title>CATEGORY</div>
</div>
<div class=list-group>
<a href=https://scotttactical.com//categories/software class=list-group-item>software</a>
</div>
</section>
<section class="panel panel-default">
<div class=panel-heading>
<div class=panel-title>SERIES</div>
</div>
<div class=list-group>
</div>
</section>
<section class="panel panel-default">
<div class=panel-heading>
<div class=panel-title>TAG</div>
</div>
<div class=list-group>
<a href=https://scotttactical.com//tags/data class=list-group-item>data</a>
<a href=https://scotttactical.com//tags/technology class=list-group-item>technology</a>
<a href=https://scotttactical.com//tags/car-computer class=list-group-item>car-computer</a>
<a href=https://scotttactical.com//tags/69-blazer class=list-group-item>69-blazer</a>
<a href=https://scotttactical.com//tags/california class=list-group-item>california</a>
<a href=https://scotttactical.com//tags/photography class=list-group-item>photography</a>
<a href=https://scotttactical.com//tags/philosophy class=list-group-item>philosophy</a>
<a href=https://scotttactical.com//tags/restoration class=list-group-item>restoration</a>
<a href=https://scotttactical.com//tags/devops class=list-group-item>devops</a>
<a href=https://scotttactical.com//tags/adventure class=list-group-item>adventure</a>
</div>
</section>
</aside>
</div>
</div>
</div>
</main>
<footer class=l-footer>
<div class=container>
<p>Copyright © 2014–2019, Scott Tactical; all rights reserved.</p>
<aside>
<p>Powered by <a href=https://gohugo.io/>Hugo</a>.</p>
<p><a href=https://github.com/dim0627/hugo_theme_beg>Beg</a> designed by <a href=http://yet.unresolved.xyz/>Daisuke Tsuji</a>.</p>
</aside>
</div>
</footer>
<script src=//code.jquery.com/jquery-3.1.1.min.js></script>
<script src=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>