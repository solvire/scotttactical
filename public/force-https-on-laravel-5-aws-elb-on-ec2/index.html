<!DOCTYPE html>

<meta charset="utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta property="og:url" content="http://scotttactical.com/">


<meta property="og:type" content="article">
<meta property="og:title" content="Force HTTPS on Laravel 5 behind AWS ELB on EC2 &middot; Scott Tactical">

<meta property="og:site_name" content="Scott Tactical">

<title>
    
    Force HTTPS on Laravel 5 behind AWS ELB on EC2
    
</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="//yandex.st/highlightjs/8.0/styles/github.min.css">
<link rel="stylesheet" href="http://scotttactical.com/css/main.css">


<script src="http://scotttactical.com//js/photo-swipe/photoswipe.min.js"></script>

<script src="http://scotttactical.com//js/photo-swipe/photoswipe-ui-default.min.js"></script>



<link rel="shortcut icon" href="http://scotttactical.com//assets/favicon.ico">


<link rel="alternate" type="application/rss+xml" title="RSS" href="http://scotttactical.com//index.xml">


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://scotttactical.com/">Scott Tactical</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="http://scotttactical.com/post">All Posts</a></li>
                        <li><a href="http://scotttactical.com/gallery">Galleries</a></li>
                        <li><a href="http://scotttactical.com/news">News</a></li>
                        <li><a href="http://scotttactical.com/tags">Tags</a></li>
                        
                        <li><a href="http://scotttactical.com/">Home</a></li>
                        
                    </ul>

                    <ul class="nav navbar-nav navbar-right">
                        
                        <li>
                            <a href="https://www.facebook.com/100005012745496" target="_blank">
                                <i class="fa fa-facebook-square"></i>
                                Facebook</a>
                        </li>
                        
                        
                        <li>
                            <a href="https://twitter.com/scott_tactical" target="_blank">
                                <i class="fa fa-twitter-square"></i>
                                Twitter</a>
                        </li>
                        
                        
                        <li>
                            <a href="https://github.com/solvire" target="_blank">
                                <i class="fa fa-github-square"></i>
                                GitHub
                            </a>
                        </li>
                        
                        
                    </ul>
                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">

            <header>
                <div class="post-date">
                    <span class="glyphicon glyphicon-calendar"></span>
                    <time itemprop="datePublished" datetime="2015-09-16T00:00:00-08:00">
                        Wed, 16 Sep 2015 00:00:00 UTC
                    </time>
                    
                </div>
                <h1 class="post-title" itemprop="headline">
                    <a href="http://scotttactical.com/force-https-on-laravel-5-aws-elb-on-ec2/">Force HTTPS on Laravel 5 behind AWS ELB on EC2</a>
                </h1>
                <span >
                  <img itemprop="image" alt="Force HTTPS on Laravel 5 behind AWS ELB on EC2" src="http://scotttactical.com/images/laravel-5.png" /><br />
                  <span itemprop="author">Scott Tactical</span><br />
                  <a itemprop="mainEntityOfPage" href="#"><span itemprop="name">Force HTTPS on Laravel 5 behind AWS ELB on EC2</span></a><br />
                  <span itemprop="publisher">Scott Tactical</span><br />
                </span>
            </header>

            <div class="post-content" itemprop="articleBody">
              <hr />
                

<h1 id="laravel-5-enforcing-https:03bc7a7611150669b29f3c91e572d932">Laravel 5 - Enforcing HTTPS</h1>

<p>I&rsquo;ve used a lot of frameworks. <a href="http://laravel.com/">Laravel is great</a>.</p>

<h2 id="dealing-with-a-load-balancer:03bc7a7611150669b29f3c91e572d932">Dealing with a load balancer</h2>

<p>Most of us are on a scaled service and most of us need HTTPS. It is much easier to put the SSL certificate on the load balancer and then proxy the request over port 80 to the actual server. It saves on CPU processes as well since the decryption work doesn&rsquo;t have to be performed on the slave boxes.</p>

<p>If you do not handle the redirect properly and just look for port 443 then you will get yourself into a <strong>redirection loop</strong>. That is annoying because if you don&rsquo;t test under an SSL you will deploy to production and then have to tell you boss why you&rsquo;re loopy. Amazon is kind of a pain for this.</p>

<h2 id="aws-elb-proxy-headers:03bc7a7611150669b29f3c91e572d932">AWS ELB Proxy Headers</h2>

<p>Make sure you know what the request looks like to the accepting server.</p>

<p>This header is going to be passed over:</p>

<p><code>HTTP_X_FORWARDED_PROTO</code></p>

<p>The problem with just looking for this and accepting your solution based on this is that header can be forged trivially. You need to make sure you are only acknowledging that header from trusted sources.</p>

<h2 id="setting-the-redirect:03bc7a7611150669b29f3c91e572d932">Setting the Redirect</h2>

<p>I went ahead and installed <a href="https://github.com/fideloper/TrustedProxy" title="Laravel Trusted Proxies" target="_blank">Laravel Trusted Proxies</a> from <a href="https://github.com/fideloper" title="Chris Fideo" target="_blank">Chris Fideo</a>.</p>

<p>Follow his instructions. It&rsquo;s pretty straight forward. Here is what my `config/trustedproxy.php` looks like.</p>

<pre><code class="language-php">'proxies' =&amp;gt; [
    '172.31.0.0/16',
],
</code></pre>

<p>I knew after looking at my logs where my health checks were coming from:`ELB-HealthChecker/1.0`</p>

<p>I figured if I just allow everything in that B block that I should be okay.</p>

<p>Also set the proper header to look for.</p>

<p>NOTE: I lost a couple hours trying to figure out why it wouldn&rsquo;t match. Read the docblock above it. It strips HTTP_  <img src="http://scotttactical.com/wp-includes/images/smilies/frownie.png" alt=":(" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>

<pre><code class="language-php">'headers' =&amp;gt; [
        \Illuminate\Http\Request::HEADER_CLIENT_IP    =&amp;gt; 'X_FORWARDED_FOR',
        \Illuminate\Http\Request::HEADER_CLIENT_HOST  =&amp;gt; 'FORWARDED_HOST',
        \Illuminate\Http\Request::HEADER_CLIENT_PROTO =&amp;gt; 'X_FORWARDED_PROTO',
        \Illuminate\Http\Request::HEADER_CLIENT_PORT  =&amp;gt; 'X_FORWARDED_PORT',
    ]
</code></pre>

<h2 id="add-to-laravel-middleware:03bc7a7611150669b29f3c91e572d932">Add to Laravel Middleware</h2>

<p>I created Secure.php and added it to app/Http/Middleware</p>

<p>Thanks to the work from <a href="https://gist.github.com/nblackburn/a66e8e93561e277996aa" title="nblackburn" target="_blank">@nblackburn</a>. That was highly appreciated.</p>

<p>What was weird about my environment is I was getting in a redirection loop because it would prepend `public/` on the front of my uri. I&rsquo;m running multiple environments so I didn&rsquo;t have the luxury of pointing my root to that directory. I had to strip that off the front.</p>

<pre><code class="language-php">class Secure implements Middleware
{
    public function handle($request, Closure $next)
    {
        if (! $request-&amp;gt;secure() &amp;&amp; app()-&amp;gt;environment('production')) {

            // this is a really ugly hack but it kept looping and prepnding public
            return redirect()-&amp;gt;secure(preg_replace('%/public%', '', $request-&amp;gt;getRequestUri()));
        }

        return $next($request);
    }
}
</code></pre>

<p>Add it to your global middleware if you want it to run for all requests.</p>

<p>Open up: app/Http/Kernel.php</p>

<p>I added</p>

<pre><code class="language-php">protected $middleware = [
	    ...		
		// trust the proxies from aws
		'Fideloper\Proxy\TrustProxies',
		// then force it secure (if production)
		'LeadFerret\Http\Middleware\Secure',
	];
</code></pre>

<p>Now there are no more redirect loop hells.</p>

            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="http://scotttactical.com//tags/php" rel="tag">
                            <i class="fa fa-tags"></i>
                            <span itemprop="keywords">php</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="http://scotttactical.com//tags/devops" rel="tag">
                            <i class="fa fa-tags"></i>
                            <span itemprop="keywords">devops</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="http://scotttactical.com//tags/laravel" rel="tag">
                            <i class="fa fa-tags"></i>
                            <span itemprop="keywords">laravel</span>
                        </a>
                    </li>
                    
                </ul>

                
                
                <h3>Related Post</h3>
                <ul class="post-rels">
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li><a href="http://scotttactical.com/post/howto-bind-multiple-terminals-macos-x/">HowTo Bind Multiple Terminals MacOS-X</a></li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li><a href="http://scotttactical.com/why-we-quit-openstack">Why We Quit OpenStack: or How I Lost 2 Months of My Life</a></li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li><a href="http://scotttactical.com/performance-suggestions-phpunit-slowness">PHPunit Slowness Performance Suggestions</a></li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li><a href="http://scotttactical.com/download-an-entire-site-with-wget-mac-osx/">Download an Entire Site with wget - mac OSX</a></li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li><a href="http://scotttactical.com/php-hypermedia-rest-api-wrapper/">PHP Hypermedia REST API wrapper</a></li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li><a href="http://scotttactical.com/to-hiphop-or-not-php-hhvm/">To HipHop or Not - PHP and HHVM</a></li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </aside>
            
            
            <footer>

                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="http://scotttactical.com/hypermedia-api-philosophy-and-talking-to-your-robot-overlords/"><span aria-hidden="true">&larr;</span> Older</a></li>
                        

                        <li><a href="http://scotttactical.com//post">All Posts</a></li>

                        
                        <li class="next"><a href="http://scotttactical.com/php-hypermedia-rest-api-wrapper/">Newer <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>

                
                
                
                <div id="disqus_thread"></div>
                <script type="text/javascript">
 
var disqus_shortname = 'scotttactical'; 

 
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                
                
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
    <div class="row">

        <div class="col-xs-12 col-sm-4 col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h2 class="panel-title">Recent Posts</h2>
                </div>
                <div class="list-group">
                    
                    <a href="/post/why-the-covered-california-website-sucks/" class="list-group-item">Why The Covered California Website Sucks</a>
                    
                    <a href="/post/internet-3rd-wave-and-rise-of-the-technology-fascist/" class="list-group-item">Internet 3rd Wave and Rise of the Technology Fascist</a>
                    
                    <a href="/post/howto-bind-multiple-terminals-macos-x/" class="list-group-item">HowTo Bind Multiple Terminals MacOS-X</a>
                    
                    <a href="/whats-wrong-with-millennials" class="list-group-item">What is Wrong With Millennials</a>
                    
                    <a href="/writing-novels-in-markdown-part1/" class="list-group-item">Writing Novels in Markdown Part 1</a>
                    
                    <a href="/why-we-quit-openstack" class="list-group-item">Why We Quit OpenStack: or How I Lost 2 Months of My Life</a>
                    
                    <a href="/dana-60-front-axle-build" class="list-group-item">General Lee-Anne 001</a>
                    
                    <a href="/grand-central-market-2016-04" class="list-group-item">Grand Central Market, Los Angeles, 2016</a>
                    
                    <a href="/moab-utah-fins-and-things-2016-03-22" class="list-group-item">Moab Utah - Fins and Things 2016</a>
                    
                    <a href="/2016/04/purdue-university-predicts-success/" class="list-group-item">Purdue University Predicts Success</a>
                    
                </div>
            </div>
        </div>

        <div class="col-xs-12 col-sm-4 col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h2 class="panel-title">Tags</h2>
                </div>
                <div class="list-group">
                    
                    
                    
                    <a href="http://scotttactical.com//tags/69-blazer" class="list-group-item">
                        <span class="badge">6</span>
                        69-blazer
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/adventure" class="list-group-item">
                        <span class="badge">4</span>
                        adventure
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/api" class="list-group-item">
                        <span class="badge">2</span>
                        api
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/california" class="list-group-item">
                        <span class="badge">8</span>
                        california
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/data" class="list-group-item">
                        <span class="badge">18</span>
                        data
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/design" class="list-group-item">
                        <span class="badge">1</span>
                        design
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/devops" class="list-group-item">
                        <span class="badge">4</span>
                        devops
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/django" class="list-group-item">
                        <span class="badge">2</span>
                        django
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/fitness" class="list-group-item">
                        <span class="badge">1</span>
                        fitness
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/go-golang" class="list-group-item">
                        <span class="badge">2</span>
                        go-golang
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/hardware" class="list-group-item">
                        <span class="badge">1</span>
                        hardware
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/healthcare" class="list-group-item">
                        <span class="badge">1</span>
                        healthcare
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/hiking" class="list-group-item">
                        <span class="badge">2</span>
                        hiking
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/hugo" class="list-group-item">
                        <span class="badge">2</span>
                        hugo
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/hypermedia" class="list-group-item">
                        <span class="badge">2</span>
                        hypermedia
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/laravel" class="list-group-item">
                        <span class="badge">2</span>
                        laravel
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/leadership" class="list-group-item">
                        <span class="badge">3</span>
                        leadership
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/linux" class="list-group-item">
                        <span class="badge">1</span>
                        linux
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/nutrition" class="list-group-item">
                        <span class="badge">1</span>
                        nutrition
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/panorama" class="list-group-item">
                        <span class="badge">2</span>
                        panorama
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/performance" class="list-group-item">
                        <span class="badge">1</span>
                        performance
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/philosophy" class="list-group-item">
                        <span class="badge">4</span>
                        philosophy
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/photography" class="list-group-item">
                        <span class="badge">8</span>
                        photography
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/php" class="list-group-item">
                        <span class="badge">4</span>
                        php
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/politics" class="list-group-item">
                        <span class="badge">3</span>
                        politics
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/restoration" class="list-group-item">
                        <span class="badge">6</span>
                        restoration
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/software" class="list-group-item">
                        <span class="badge">4</span>
                        software
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/system-administration" class="list-group-item">
                        <span class="badge">1</span>
                        system-administration
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/technology" class="list-group-item">
                        <span class="badge">6</span>
                        technology
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/testing" class="list-group-item">
                        <span class="badge">1</span>
                        testing
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/wheeling" class="list-group-item">
                        <span class="badge">4</span>
                        wheeling
                    </a>
                    
                    
                    <a href="http://scotttactical.com//tags/writing" class="list-group-item">
                        <span class="badge">1</span>
                        writing
                    </a>
                    
                </div>
            </div>
        </div>

    </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2016  Scott Tactical </p>
	<p>Powered by <a href="http://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script src="//yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53440065-2', 'auto');
ga('send', 'pageview');

</script>

<script>
document.write('<script src="//sharebutton.net/plugin/sharebutton.php?type=horizontal&u=' + encodeURIComponent(document.location.href) + '"></scr' + 'ipt>');
</script>

